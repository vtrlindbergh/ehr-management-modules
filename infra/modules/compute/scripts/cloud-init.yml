#cloud-config

# Cloud-init configuration for Hyperledger Fabric nodes
# VM Role: ${vm_role}

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - jq
  - unzip
  - wget
  - htop
  - tree

# Configure Docker
runcmd:
  # Redirect all output to log file for debugging
  - exec > /var/log/cloud-init-ehr.log 2>&1
  
  # Add user to docker group
  - usermod -aG docker ${admin_username}
  
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Format and mount data disk
  - mkfs.ext4 /dev/sdc
  - mkdir -p /opt/hyperledger
  - mount /dev/sdc /opt/hyperledger
  - echo '/dev/sdc /opt/hyperledger ext4 defaults 0 2' >> /etc/fstab
  - chown -R ${admin_username}:${admin_username} /opt/hyperledger
  
  # Install Docker Compose (stable version)
  - curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Install Go 1.22.7 (matching go.mod and local dev environment)
  - cd /tmp
  - wget https://go.dev/dl/go1.22.7.linux-amd64.tar.gz
  - rm -rf /usr/local/go
  - tar -C /usr/local -xzf go1.22.7.linux-amd64.tar.gz
  
  # Create hyperledger directories (no brace expansion â€” cloud-init uses /bin/sh)
  - mkdir -p /opt/hyperledger/fabric-samples
  - mkdir -p /opt/hyperledger/chaincode
  - mkdir -p /opt/hyperledger/config
  - mkdir -p /opt/hyperledger/crypto-config
  - mkdir -p /opt/hyperledger/logs
  - chown -R ${admin_username}:${admin_username} /opt/hyperledger
  
  # Install Hyperledger Fabric 2.5.10 binaries (matching local dev environment)
  - cd /opt/hyperledger
  - curl -sSL https://bit.ly/2ysbOFE | bash -s -- 2.5.10 1.5.12
  - chown -R ${admin_username}:${admin_username} /opt/hyperledger
  
  # Download EHR chaincode
  - cd /opt/hyperledger
  - git clone https://github.com/vtrlindbergh/ehr-management-modules.git chaincode-source
  - cp -r chaincode-source/chaincode/* /opt/hyperledger/chaincode/
  - chown -R ${admin_username}:${admin_username} /opt/hyperledger/chaincode
  
  # Set up environment for Hyperledger Fabric
  - echo 'export PATH=/usr/local/go/bin:/opt/hyperledger/fabric-samples/bin:$PATH' >> /home/${admin_username}/.bashrc
  - echo 'export FABRIC_CFG_PATH=/opt/hyperledger/fabric-samples/config' >> /home/${admin_username}/.bashrc
  - echo 'cd /opt/hyperledger' >> /home/${admin_username}/.bashrc

# Create a marker file to indicate cloud-init completion
write_files:
  - path: /opt/hyperledger/cloud-init-complete
    content: |
      Cloud-init setup completed at $(date)
      VM Role: ${vm_role}
      Docker installed and configured
      Hyperledger directories created
    permissions: '0644'
    owner: ${admin_username}:${admin_username}

final_message: "Hyperledger Fabric VM (${vm_role}) setup completed. Docker is ready, and Hyperledger directories are prepared."